version: 2

deploy:
  steps:
    setupVariables:
      after:
        - name: Install GH CLI
          run: |
            # this step can be embedded into custom image for self-hosted agents
            sudo apk add github-cli
        - name: Process Turbo Webhook
          run: |
            set -ex
            # assume $TARGET_FILEPATH, $ENV_DIR, $NEW_TFVAR
            # create branch
            git config --global user.email "turbo@env0.com"
            git config --global user.name "Turbo Bot"
            git checkout -b turbo-update-var
            # create/update file 
            echo "{/"instance_type/":/"$NEW_TFVAR/"}" > $TARGET_FILEPATH 
            ls -la dev
            cat $TARGET_FILEPATH 
            # commit file
            echo "commit file"
            git add $TARGET_FILEPATH
            git commit -am "turbo initiated variable change"
            # push changes
            echo "push changes"
            git config --global url.ssh://git@github.com/env0.insteadOf https://github.com/env0
            git push -u origin turbo-update-var
            # maybe need to use GH AUTH LOGIN
            export GITHUB_TOKEN=$ENV0_VCS_ACCESS_TOKEN
            # create PR with `gh` cli
            gh pr create --title "Update Instance Size" --body "Turbo Triggered Update" --base main
          env:
            TARGET_FILEPATH: "dev/test.auto.tfvars"
            NEW_TFVAR: "t3a.micro"