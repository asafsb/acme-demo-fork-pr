version: 2

deploy:
  steps:
    setupVariables:
      after:
        - name: Install GH CLI
          run: |
            # this step can be embedded into custom image for self-hosted agents
            apk add github-cli
        - name: Process Turbo Webhook
          run: |
            # assume $TARGET_FILEPATH, $ENV_DIR, $NEW_TFVAR
            # create branch
            git checkout -b turbo-update-var
            # create/update file 
            echo "{/"instance_type/":/"$NEW_TFVAR/"}" > $TARGET_FILEPATH 
            # commit file
            git commit -m "turbo initiated variable change"
            # push changes
            git push -u origin turbo-update-var
            # maybe need to use GH AUTH LOGIN
            export GITHUB_TOKEN=$ENV0_VCS_ACCESS_TOKEN
            # create PR with `gh` cli
            gh pr create --title "Update Instance Size" --body "Turbo Triggered Update" --base main
          env:
            TARGET_FILEPATH: "git-pr-creator/dev"