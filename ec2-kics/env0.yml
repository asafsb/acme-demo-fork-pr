version: 2
deploy:
  steps:
    setupVariables:
      after:
        - name: KiCS Install
          run: | 
            if [[ -e "kics/bin/kics" ]]; then 
              sudo apk add go
              git clone https://github.com/Checkmarx/kics.git
              cd kics; go build -o ./bin/kics cmd/console/main.go
              #cd kics; cp ./bin/kics /opt
              cp kics/bin/kics /opt
            fi
            kics version
    terraformPlan:
      after:
        - name: KiCS Scan
          run: |
            terraform show -json .tf-plan > tfplan.json
            ls -la
            kics scan -p "tfplan.json" --no-progress -q "/tmp/88a77674-7a2a-4445-8954-68e8d235ee3e/ec2-kics/kics/assets/queries"
